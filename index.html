<script>
    // بياناتك الخاصة
    const CONFIG = {
        host: "http://live.stablechannels.tv:80",
        user: "nfsthbbx",
        pass: "vFf8aZ2n92"
    };

    let allChannels = [];
    const video = document.getElementById('player');
    let hls = new Hls();

    // دالة تحميل القنوات من السيرفر
    async function loadMyServer() {
        const statusTag = document.getElementById('loadStatus');
        statusTag.textContent = "جاري الاتصال بالسيرفر...";
        
        // رابط الـ M3U الخاص بك
        const m3uUrl = `${CONFIG.host}/get.php?username=${CONFIG.user}&password=${CONFIG.pass}&type=m3u_plus&output=ts`;
        
        // تمرير الرابط عبر البروكسي لتجنب الحجب
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(m3uUrl)}`;

        try {
            const response = await fetch(proxyUrl);
            const data = await response.text();
            
            // تحليل ملف القنوات
            const lines = data.split('\n');
            allChannels = [];
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    const name = lines[i].split(',')[1]?.trim() || "قناة غير معروفة";
                    const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "https://cdn-icons-png.flaticon.com/512/716/716429.png";
                    const stream = lines[i+1]?.trim();
                    if (stream) allChannels.push({ name, logo, stream });
                }
            }
            
            displayChannels(allChannels);
            statusTag.textContent = "تم تحديث القنوات بنجاح ✅";
            document.getElementById('totalCount').textContent = `${allChannels.length} قناة`;
            
        } catch (err) {
            statusTag.textContent = "خطأ في الاتصال ❌";
            console.error(err);
        }
    }

    function displayChannels(list) {
        const container = document.getElementById('listContainer');
        container.innerHTML = ''; // تنظيف القائمة
        list.forEach((c, index) => {
            const div = document.createElement('div');
            div.className = 'channel-item';
            div.innerHTML = `<img src="${c.logo}"> <div class="info"><b>${c.name}</b></div>`;
            div.onclick = () => playChannel(c);
            container.appendChild(div);
        });
    }

    function playChannel(channel) {
        document.getElementById('viewName').textContent = channel.name;
        // تشغيل الرابط عبر البروكسي
        const finalStreamUrl = `/api/proxy?url=${encodeURIComponent(channel.stream)}`;

        if (Hls.isSupported()) {
            hls.destroy();
            hls = new Hls();
            hls.loadSource(finalStreamUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = finalStreamUrl;
            video.play();
        }
    }
</script>
